---
layout: post
title: Redis快速入门总结
tags: 缓存 Redis
categories: 缓存
published: true
---


## 关系型数据库和非关系型数据库

### 优缺点

* 关系型数据库：数据和数据之间，表和字段之间、表和表之间是存在关系的
	- 优点
		+ 进行增删改查是非常方便的
		+ 有事务操作，保证数据完整性
	- 缺点
		+ 关系由大量算法保证，拉低运行速度，消耗系统资源
		+ 海量数据增删改查会显得无能为力
		+ 海量数据对数据表维护和扩展也变得无能为力
* 非关系型数据库(NoSQL)：
	- 优点
		+ 海量数据增删改查轻松应对
		+ 海量数据维护非常轻松
	- 缺点
		+ 数据不能一目了然（没有表和字段关系）
		+ 没有强大的事务保证数据的完整和安全

### NoSQl分类

* 键值对存储数据库：
	- 相关产品：Tokyo Cabinet/Tyrant、Redis、Voldemort、Berkeley DB
	- 典型应用：内容缓存，主要用于处理大量数据的高访问负载
	- 数据模型：一系列键值对
	- 优势：优秀的快速查询，稳定性强
	- 劣势：存储的数据缺少结构化
* 列存储数据库：
	- 相关产品：Apache Cassandra、Apache HBase、Riak
	- 典型应用：分布式的文件系统
	- 数据模型：以列簇式村塾，将同一列数据存在一起
	- 优势：查找速度快，可扩展性强，更容易进行分布式扩展
	- 劣势：功能相对局限，使用极大的内存才可调配，且系统处理算法时将有数秒甚至更长的时间不可以哦那个，导致大量处理超时
* 文档型数据库（淘汰）
	- 相关产品：CouchDB、MongoDB
	- 典型应用：Web应用（与key-value类似），value是结构化的
	- 数据模型：一系列键值对
	- 优势：数据结构要求不严格
	- 劣势：查询性能不高，切缺乏统一的查询语法
* 图形数据库
	- 相关产品：Neo4J、InfoGrid、Infinite Graph
	- 典型应用：社交网络
	- 数据模型：图结构
	- 优势：利用图结构相关算法
	- 劣势：需要对整个图结算才能得出结果，不容易做分布式集群方案，局限性强

---

`Redis`是一个开源，先进的key-value存储，并用于构建高性能，可扩展的Web应用程序的完美解决方案。

**Redis从它的许多竞争继承来的三个主要特点：**

* Redis数据库完全在内存中，使用磁盘仅用于持久性。

* 相比许多键值数据存储，Redis拥有一套较为丰富的数据类型。

* Redis可以将数据复制到任意数量的从服务器。

**Redis 优势**

* *异常快速*：Redis的速度非常快，每秒能执行约11万集合，每秒约81000+条记录。

* *支持丰富的数据类型*：Redis支持最大多数开发人员已经知道像列表，集合，有序集合，散列数据类型。这使得它非常容易解决各种各样的问题，因为我们知道哪些问题是可以处理通过它的数据类型更好。

* *操作都是原子性*：所有Redis操作是原子的，这保证了如果两个客户端同时访问的Redis服务器将获得更新后的值。

* *多功能实用工具*：Redis是一个多实用的工具，可以在多个用例如缓存，消息，队列使用(Redis原生支持发布/订阅)，任何短暂的数据，应用程序，如Web应用程序会话，网页命中计数等。

## 常用命令 ##

### 启动 ###

```shell
$redis-server
```

#### 自启动

存为redis,放到/etc/init.d/下面  
上面的注释的意思是，redis服务必须在运行级2，3，4，5下被启动或关闭，启动的优先级是90，关闭的优先级是10。

```
# chkconfig:   2345 90 10
# description:  Redis is a persistent key-value database

PATH=/usr/local/bin:/sbin:/usr/bin:/bin  

REDISPORT=6379  
EXEC=/usr/local/bin/redis-server  
REDIS_CLI=/usr/local/bin/redis-cli  

PIDFILE=/var/run/redis_6379.pid  
CONF="/etc/redis/redis.conf"  

case "$1" in  
    start)  
        if [ -f $PIDFILE ]  
        then  
                echo "$PIDFILE exists, process is already running or crashed"  
        else  
                echo "Starting Redis server..."  
                $EXEC $CONF  
        fi  
        if [ "$?"="0" ]   
        then  
              echo "Redis is running..."  
        fi  
        ;;  
    stop)  
        if [ ! -f $PIDFILE ]  
        then  
                echo "$PIDFILE does not exist, process is not running"  
        else  
                PID=$(cat $PIDFILE)  
                echo "Stopping ..."  
                $REDIS_CLI -p $REDISPORT SHUTDOWN  
                while [ -x ${PIDFILE} ]  
               do  
                    echo "Waiting for Redis to shutdown ..."  
                    sleep 1  
                done  
                echo "Redis stopped"  
        fi  
        ;;  
   restart|force-reload)  
        ${0} stop  
        ${0} start  
        ;;  
  *)  
    echo "Usage: /etc/init.d/redis {start|stop|restart|force-reload}" >&2  
        exit 1  
esac
```

```shell
chmod +x /etc/init.d/redis

service redis start   #或者 /etc/init.d/redis start  
service redis stop   #或者 /etc/init.d/redis stop  
# 自动启动
chkconfig --add redis
chkconfig redis on
```


### 检查Redis是否在工作 ###

```bash
$redis-cli
redis 127.0.0.1:6379>
```

现在输入PING命令检查连接

```shell
redis 127.0.0.1:6379> ping
PONG
```

**在远程服务器上执行命令**

```shell
$redis-cli -h 127.0.0.1 -p 6379 -a "mypass"
redis 127.0.0.1:6379>
redis 127.0.0.1:6379> PING

PONG
```

### 键操作 ###

| 命令                                 | 作用                                             | 示例                                                                                                                                                                                                              |
| :---                                 | :---                                             | :---                                                                                                                                                                                                              |
| DEL key                              | 此命令删除键，如果存在。返回受影响行数           |                                                                                                                                                                                                                   |
| DUMP key                             | 该命令返回存储在指定键的值的序列化版本。         |                                                                                                                                                                                                                   |
| EXISTS key                           | 此命令检查该键是否存在。                         |                                                                                                                                                                                                                   |
| EXPIRE key seconds                   | 指定键的过期时间                                 |                                                                                                                                                                                                                   |
| EXPIREAT key timestamp               | 指定的键过期时间。在这里，时间是在Unix时间戳格式 |                                                                                                                                                                                                                   |
| PEXPIRE key milliseconds             | 设置键以毫秒为单位到期                           |                                                                                                                                                                                                                   |
| PEXPIREAT key milliseconds-timestamp | 设置键在Unix时间戳指定为毫秒到期                 |                                                                                                                                                                                                                   |
| KEYS pattern                         | 查找与指定模式匹配的所有键                       | redis 127.0.0.1:6379> KEYS tutorial* <br/> 1) "tutorial3" <br/> 2) "tutorial1" <br/> 3) "tutorial2"                                                                                                               |
| MOVE key db                          | 移动键到另一个数据库                             |                                                                                                                                                                                                                   |
| PERSIST key                          | 移除过期的键                                     |                                                                                                                                                                                                                   |
| PTTL key                             | 以毫秒为单位获取剩余时间的到期键。               |                                                                                                                                                                                                                   |
| TTL key                              | 获取键到期的剩余时间。                           |                                                                                                                                                                                                                   |
| RANDOMKEY                            | 从Redis返回随机键                                | redis 127.0.0.1:6379> SET tutorial1 redis<br/>OK<br/>redis 127.0.0.1:6379> SET tutorial2 mysql<br/>OK<br/>redis 127.0.0.1:6379> SET tutorial3 mongodb<br/>OK<br/>redis 127.0.0.1:6379> RANDOMKEY<br/>1) tutorial3 |
| RENAME key newkey                    | 更改键的名称                                     |                                                                                                                                                                                                                   |
| RENAMENX key newkey                  | 重命名键，如果新的键不存在                       |                                                                                                                                                                                                                   |
| TYPE key                             | 返回存储在键的数据类型的值。                     |                                                                                                                                                                                                                   |

```shell
## 查询key总数
eval "return #redis.call('keys', 'prefix-*')" 0
```

---

## 数据类型 ##

Redis支持5种类型的数据类型

所有的key都是字符串，key不要太长，影响使用效率

### 字符串 ###

Redis字符串是字节序列。Redis字符串是二进制安全的，这意味着他们有一个已知的长度没有任何特殊字符终止，所以你可以存储任何东西，512兆为上限。

**Redis字符串是二进制安全的**

* 在关系型数据库中，频繁的编码解码浪费大量是系统性能，同时可能出现乱码
* redis的编码和解码只会出现在客户端，执行效率很高，并不会出现乱码
	- key中字符串使用unicode编码：你--"\xe4\xbd\xa0"

```shell
redis 127.0.0.1:6379> SET name "yiibai"
OK
redis 127.0.0.1:6379> GET name
"yiibai"
```

| 命令                             | 作用                                       | 示例                                                                                                                                                                                             |
| :---                             | :---                                       | :---                                                                                                                                                                                             |
| SET key value                    | 此命令用于在指定键设置值                   |                                                                                                                                                                                                  |
| GET key                          | 键对应的值。                               |                                                                                                                                                                                                  |
| GETRANGE key start end           | 得到字符串的子字符串存放在一个键           | redis 127.0.0.1:6379> SET mykey "This is my test key"<br/>OK<br/>redis 127.0.0.1:6379> GETRANGE mykey 0 3<br/>"This"<br/>redis 127.0.0.1:6379> GETRANGE mykey 0 -1<br/>"This is my test key"     |
| GETSET key value                 | 设置键的字符串值，并返回旧值               |                                                                                                                                                                                                  |
| GETBIT key offset                | 返回存储在键位值的字符串值的偏移           |                                                                                                                                                                                                  |
| MGET key1 [key2..]               | 得到所有的给定键的值                       | redis 127.0.0.1:6379> SET key1 "hello"<br/>OK<br/>redis 127.0.0.1:6379> SET key2 "world"<br/>OK<br/>redis 127.0.0.1:6379> MGET key1 key2 someOtherKey<br/>1) "Hello"<br/>2) "World"<br/>3) (nil) |
| SETBIT key offset value          | 设置或清除该位在存储在键的字符串值偏移     |                                                                                                                                                                                                  |
| SETEX key seconds value          | 键到期时设置值                             |                                                                                                                                                                                                  |
| SETNX key value                  | 设置键的值，只有当该键不存在               |                                                                                                                                                                                                  |
| SETRANGE key offset value        | 覆盖字符串的一部分从指定键的偏移           |                                                                                                                                                                                                  |
| STRLEN key                       | 得到存储在键的值的长度                     |                                                                                                                                                                                                  |
| MSET key value [key value ...]   | 设置多个键和多个值                         |                                                                                                                                                                                                  |
| MSETNX key value [key value ...] | 设置多个键多个值，只有在当没有按键的存在时 |                                                                                                                                                                                                  |
| PSETEX key milliseconds value    | 设置键的毫秒值和到期时间                   |                                                                                                                                                                                                  |
| INCR key                         | 增加键的整数值一次                         | 不存在的值incr后为1，非数值型报错                                                                                                                                                                |
| INCRBY key increment             | 由给定的数量递增键的整数值                 |                                                                                                                                                                                                  |
| INCRBYFLOAT key increment        | 由给定的数量递增键的浮点值                 |                                                                                                                                                                                                  |
| DECR key                         | 递减键一次的整数值                         | 不存在的值incr后为-1                                                                                                                                                                             |
| DECRBY key decrement             | 由给定数目递减键的整数值                   |                                                                                                                                                                                                  |
| APPEND key value                 | 追加值到一个键                             | 拼接字符串，返回拼接后长度                                                                                                                                                                       |

### 哈希 ###

Redis的哈希是键值对的集合。 Redis的哈希值是字符串字段和字符串值之间的映射，因此它们被用来表示对象。

Hash占用的空间很小

```shell
redis 127.0.0.1:6379> HMSET user:1 username yiibai password yiibai points 200
OK
redis 127.0.0.1:6379> HGETALL user:1

1) "username"
2) "yiibai"
3) "password"
4) "yiibai"
5) "points"
6) "200"

# 返回结果为key value对应的列表 count大小决定查询总数 
# key后面的0表示cursor位置，如果未查询到需要在下次查询中携带上次位置
# match及参数为模糊匹配
redis 127.0.0.1:6379> HSCAN key 0 match "*1*" count 10000000
1) "0"
2) 1) "1232"
   2) "value1"
   3) "1862324"
   4) "value2"
```

| 命令                                           | 作用                               | 备注                        |
| :---                                           | :---                               |                             |
| HDEL key field2 [field2]                       | 删除一个或多个哈希字段             | 如果filed为空，hash也被删除 |
| HEXISTS key field                              | 判断一个哈希字段存在与否           |                             |
| HGET key field                                 | 获取存储在指定的键散列字段的值     | 返回新增的map键的个数       |
| HGETALL key                                    | 返回哈希中所有的键和值             |                             |
| HINCRBY key field increment                    | 由给定数量增加的哈希字段的整数值   |                             |
| HINCRBYFLOAT key field increment               | 由给定的递增量哈希字段的浮点值     |                             |
| HKEYS key                                      | 获取所有在哈希字段                 |                             |
| HLEN key                                       | 获取哈希字段数                     |                             |
| HMGET key field1 [field2]                      | 获得所有给定的哈希字段的值         |                             |
| HMSET key field1 value1 [field2 value2 ]       | 设置多个哈希字段的多个值           |                             |
| HSET key field value                           | 设置哈希字段的字符串值             |                             |
| HSETNX key field value                         | 设置哈希字段的值，仅当该字段不存在 |                             |
| HVALS key                                      | 获取在哈希中的所有值               |                             |
| HSCAN key cursor [MATCH pattern] [COUNT count] | 增量迭代哈希字段及相关值           |                             |

### 列表 ###

Redis的列表是简单的字符串列表，排序插入顺序。您可以添加元素到Redis的列表的头部或尾部。

Redis列表是双向链表，适合做大数据集合的增删和任务队列

```shell
redis 127.0.0.1:6379> lpush tutoriallist redis
(integer) 1
redis 127.0.0.1:6379> lpush tutoriallist mongodb
(integer) 2
redis 127.0.0.1:6379> lpush tutoriallist rabitmq
(integer) 3
redis 127.0.0.1:6379> lrange tutoriallist 0 10

1) "rabitmq"
2) "mongodb"
3) "redis"
```

列表的最大长度为 2^32 - 1 元素（4294967295，每个列表中可容纳超过4十亿的元素）。

| 命令                                    | 作用                                                            | 备注                                                              |
| :---                                    | :---                                                            |                                                                   |
| BLPOP key1 [key2 ] timeout              | 取出并获取列表中的第一个元素，或阻塞，直到有可用                |                                                                   |
| BRPOP key1 [key2 ] timeout              | 取出并获取列表中的最后一个元素，或阻塞，直到有可用              |                                                                   |
| BRPOPLPUSH source destination timeout   | 从列表中弹出一个值，它推到另一个列表并返回它;或阻塞，直到有可用 |                                                                   |
| LINDEX key index                        | 从一个列表其索引获取对应的元素                                  |                                                                   |
| LINSERT key BEFORE（AFTER） pivot value | 在列表中的其他元素之后或之前插入一个元素                        | 要建立索引效率不高                                                |
| LLEN key                                | 获取列表的长度                                                  |                                                                   |
| LPOP key                                | 获取并取出列表中的第一个元素                                    | 取出为空后列表也被删除                                            |
| LPUSH key value1 [value2]               | 在前面加上一个或多个值的列表                                    |                                                                   |
| LPUSHX key value                        | 在前面加上一个值列表，仅当列表中存在                            |                                                                   |
| LRANGE key start stop                   | 从一个列表获取各种元素                                          | 可以为负数，从后面开始数，range为0 -1则是整个列表                 |
| LREM key count value                    | 从列表中删除元素                                                | 要建立索引效率不高，count为0删除所有，为负数从尾部开始向前删除    |
| LSET key index value                    | 在列表中的索引设置一个元素的值                                  | 要建立索引效率不高                                                |
| LTRIM key start stop                    | 修剪列表到指定的范围内                                          |                                                                   |
| RPOP key                                | 取出并获取列表中的最后一个元素                                  |                                                                   |
| RPOPLPUSH source destination            | 删除最后一个元素的列表，将其附加到另一个列表并返回它            | 两个参数都是自身实现列表循环                                      |
| RPUSH key value1 [value2]               | 添加一个或多个值到列表                                          | lpush list1 a b c d [d,c,b,a] <br/> rpush list2 a b c d [a,b,c,d] |
| RPUSHX key value                        | 添加一个值列表，仅当列表中存在                                  |                                                                   |

### 集合 ###

Redis的集合是字符串的无序集合，不允许重复。在Redis您可以添加，删除和测试文件是否存在，在成员O(1)的时间复杂度。

大数据集合的交集、并集、差集运算都依赖set

```shell
redis 127.0.0.1:6379> sadd tutoriallist redis
(integer) 1
redis 127.0.0.1:6379> sadd tutoriallist mongodb
(integer) 1
redis 127.0.0.1:6379> sadd tutoriallist rabitmq
(integer) 1
redis 127.0.0.1:6379> sadd tutoriallist rabitmq
(integer) 0
redis 127.0.0.1:6379> smembers tutoriallist

1) "rabitmq"
2) "mongodb"
3) "redis"
```

|                      命令                      |               说明               |
|------------------------------------------------|----------------------------------|
| SADD key member1 [member2]                     | 将一个或多个成员添加到集合       |
| SCARD key                                      | 获取集合中的成员数               |
| SDIFF key1 [key2]                              | 减去多个集合                     |
| SDIFFSTORE destination key1 [key2]             | 减去多个集并将结果集存储在键中   |
| SINTER key1 [key2]                             | 相交多个集合                     |
| SINTERSTORE destination key1 [key2]            | 交叉多个集合并将结果集存储在键中 |
| SISMEMBER key member                           | 判断确定给定值是否是集合的成员   |
| SMOVE source destination member                | 将成员从一个集合移动到另一个集合 |
| SPOP key                                       | 从集合中删除并返回随机成员       |
| SRANDMEMBER key [count]                        | 从集合中获取一个或多个随机成员   |
| SREM key member1 [member2]                     | 从集合中删除一个或多个成员       |
| SUNION key1 [key2]                             | 添加多个集合                     |
| SUNIONSTORE destination key1 [key2]            | 添加多个集并将结果集存储在键中   |
| SSCAN key cursor [MATCH pattern] [COUNT count] | 递增地迭代集合中的元素           |
| SMEMBERS key                                   | 查看set中所有元素                |

*在上面的例子中rabitmq集合添加加两次，但由于集合元素具有唯一属性。*

### 有序集合 ###

Redis的有序集合类似于Redis的集合，字符串不重复的集合。不同的是，一个有序集合的每个成员用分数，以便采取有序set命令，从最小的到最大的成员分数有关。虽然成员具有唯一性，但分数可能会重复。

使用分数保证元素有序，每个元素都要手动赋分，适合做排行榜

```shell
redis 127.0.0.1:6379> zadd tutoriallist 0 redis
(integer) 1
redis 127.0.0.1:6379> zadd tutoriallist 0 mongodb
(integer) 1
redis 127.0.0.1:6379> zadd tutoriallist 0 rabitmq
(integer) 1
redis 127.0.0.1:6379> zadd tutoriallist 0 rabitmq
(integer) 0
redis 127.0.0.1:6379> ZRANGEBYSCORE tutoriallist 0 1000

1) "redis"
2) "mongodb"
3) "rabitmq"

```

| 命令                                           | 作用                                                           | 示例                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :---                                           | :---                                                           | :---                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ZADD key score1 member1 [score2 member2]       | 添加一个或多个成员到有序集合，或者如果它已经存在更新其分数     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZCARD key                                      | 得到的有序集合成员的数量                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZCOUNT key min max                             | 计算一个有序集合成员与给定值范围内的分数                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZINCRBY key increment member                   | 在有序集合增加成员的分数                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZINTERSTORE destination numkeys key [key ...]  | 多重交叉排序集合，并存储生成一个新的键有序集合。               | redis 127.0.0.1:6379> ZADD myset 1 "hello"<br/>(integer) 1<br/>redis 127.0.0.1:6379> ZADD myset 2 "world"<br/>(integer) 1<br/>redis 127.0.0.1:6379> ZADD myset2 1 "hello"<br/>(integer) 1<br/>redis 127.0.0.1:6379> ZADD myset2 2 "world"<br/>(integer) 1<br/>redis 127.0.0.1:6379> ZADD myset2 3 "foo"<br/>(integer) 1<br/>redis 127.0.0.1:6379> ZINTERSTORE out 2 myset1 myset2 WEIGHTS 2 3"<br/>(integer) 3<br/>redis 127.0.0.1:6379> ZRANGE out 0 -1 WITHSCORES<br/>1) "hello"<br/>2) "5"<br/>3) "world"<br/>4) "10" |
| ZLEXCOUNT key min max                          | 计算一个给定的字典范围之间的有序集合成员的数量                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZRANGE key start stop [WITHSCORES]             | 由索引返回一个成员范围的有序集合。                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZRANGEBYLEX key min max [LIMIT offset count]   | 返回一个成员范围的有序集合（由字典范围）                       | redis 127.0.0.1:6379> ZADD myzset 0 a 0 b 0 c 0 d 0 e<br/>(integer) 5<br/>redis 127.0.0.1:6379> ZADD myzset 0 f 0 g<br/>(integer) 2<br/>redis 127.0.0.1:6379> ZRANGEBYLEX myzset - [c<br/>1) "a"<br/>2) "b"<br/>3) "c"<br/>redis 127.0.0.1:6379> ZRANGEBYLEX myzset - (c<br/>1) "a"<br/>2) "b" <br/> **两个开始和结束是从零开始的索引，其中0是第一个元素，1是下一个元素等等。它们也可以是表示偏移量从有序集的结尾，以-1作为排序的集合的最后一个元素，-2倒数第二元素等负数。**                                            |
| ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT] | 按分数返回一个成员范围的有序集合。                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZRANK key member                               | 确定成员的索引中有序集合                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREM key member [member ...]                   | 从有序集合中删除一个或多个成员                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREMRANGEBYLEX key min max                     | 删除所有成员在给定的字典范围之间的有序集合                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREMRANGEBYRANK key start stop                 | 在给定的索引之内删除所有成员的有序集合                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREMRANGEBYSCORE key min max                   | 在给定的分数之内删除所有成员的有序集合                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREVRANGE key start stop [WITHSCORES]          | 返回一个成员范围的有序集合，通过索引，以分数排序，从高分到低分 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREVRANGEBYSCORE key max min [WITHSCORES]      | 返回一个成员范围的有序集合，按分数，以分数排序从高分到低分     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZREVRANK key member                            | 确定一个有序集合成员的索引，以分数排序，从高分到低分           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZSCORE key member                              | 获取给定成员相关联的分数在一个有序集合                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZUNIONSTORE destination numkeys key [key ...]  | 添加多个集排序，所得排序集合存储在一个新的键                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ZSCAN key cursor [MATCH pattern] [COUNT count] | 增量迭代排序元素集和相关的分数                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

## 消息订阅和发布 ##

|                    命令                   |                说明                |
|-------------------------------------------|------------------------------------|
| PSUBSCRIBE pattern [pattern …]            | 订阅一个或多个符合给定模式的频道。 |
| PUBSUB subcommand [argument [argument …]] | 查看订阅与发布系统状态。           |
| PUBLISH channel message                   | 将信息发送到指定的频道。           |
| PUNSUBSCRIBE [pattern [pattern …]]        | 退订所有给定模式的频道。           |
| SUBSCRIBE channel [channel …]             | 订阅给定的一个或多个频道的信息。   |
| UNSUBSCRIBE [channel [channel …]]         | 退订给定的频道。                   |

## 事务 ##

Redis事务让一组命令在单个步骤执行。事务中有两个属性，说明如下：

* 在一个事务中的所有命令按顺序执行作为单个隔离操作。通过另一个客户端发出的请求在Redis的事务的过程中执行，这是不可能的。

* Redis的事务具有原子性。原子意味着要么所有的命令都执行或都不执行。

* 有一条命令执行失败，剩余的命令还是会执行

```shell
redis 127.0.0.1:6379> MULTI
OK
redis 127.0.0.1:6379> SET tutorial redis
QUEUED
redis 127.0.0.1:6379> GET tutorial
QUEUED
redis 127.0.0.1:6379> INCR visitors
QUEUED
redis 127.0.0.1:6379> EXEC

1) OK
2) "redis"
3) (integer) 1
```

| 命令                | 作用                               |
| :---                | :---                               |
| DISCARD             | 发出命令MULTI后丢弃所有            |
| EXEC                | MULTI后执行发出所有命令            |
| MULTI               | 标记事务块的开始                   |
| UNWATCH             | 取消所有的对应关注键               |
| WATCH key [key ...] | 关注给定项，以确定执行MULTI/EXEC块 |

## 脚本 ##

Redis脚本使用Lua解释器用于计算脚本。它Redis从2.6.0版本开始内置。使用脚本eval命令。

```shell
redis 127.0.0.1:6379> EVAL "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}" 2 key1 key2 first second

1) "key1"
2) "key2"
3) "first"
4) "second"
```

| 命令                                             | 作用                          |
| :---                                             | :---                          |
| EVAL script numkeys key [key ...] arg [arg ...]  | 执行一个Lua脚本。             |
| EVALSHA sha1 numkeys key [key ...] arg [arg ...] | 执行一个Lua脚本。             |
| SCRIPT EXISTS script [script ...]                | 检查脚本是否存在于缓存中。    |
| SCRIPT FLUSH                                     | 删除脚本缓存中的所有脚本。    |
| SCRIPT KILL                                      | 终止目前在执行的脚本。        |
| SCRIPT LOAD script                               | 加载指定的Lua脚本到脚本缓存。 |

## 连接 ##

Redis的连接命令基本上都是用于管理Redis的服务器与客户端连接。

```shell
redis 127.0.0.1:6379> AUTH "password"
OK
redis 127.0.0.1:6379> PING
PONG
```

| 命令          | 作用                   | 示例                                                                                                   |
| :---          | :---                   | :---                                                                                                   |
| AUTH password | 服务器验证给定的密码   |                                                                                                        |
| ECHO message  | 打印给定的字符串       |                                                                                                        |
| PING          | 检查服务器是否正在运行 |                                                                                                        |
| QUIT          | 关闭当前连接           |                                                                                                        |
| SELECT index  | 更改当前连接所选数据库 | 默认在0号数据库，总共16个数据库<br/>redis 127.0.0.1:6379> SELECT 1<br/>OK<br/>redis 127.0.0.1:6379[1]> |

## 数据库

| 命令           | 作用                    | 示例                                                                                                   |
| :---           | :---                    | :---                                                                                                   |
| SELECT index   | 更改当前连接所选数据库  | 默认在0号数据库，总共16个数据库<br/>redis 127.0.0.1:6379> SELECT 1<br/>OK<br/>redis 127.0.0.1:6379[1]> |
| MOVE key index | 将key移动到指定的数据库 |                                                                                                        |
| FLUSHDB        | 清空数据库              |                                                                                                        |
| FLUSHALL       | 清空整个redis           |                                                                                                        |


## 服务端 ##

Redis服务器命令基本上都用于管理Redis服务器。

| 命令                                         | 作用                                       |
| :---                                         | :---                                       |
| BGREWRITEAOF                                 | 异步改写仅追加文件                         |
| BGSAVE                                       | 异步保存数据集到磁盘（快照）               |
| CLIENT KILL [ip:port] [ID client-id]         | 杀死一个客户端的连接                       |
| CLIENT LIST                                  | 获取客户端连接到服务器的连接列表           |
| CLIENT GETNAME                               | 获取当前连接的名称                         |
| CLIENT PAUSE timeout                         | 停止指定的时间处理来自客户端的命令         |
| CLIENT SETNAME connection-name               | 设置当前连接名称                           |
| CLUSTER SLOTS                                | 获取集群插槽数组节点的映射                 |
| COMMAND                                      | 获取Redis的命令的详细信息数组              |
| COMMAND COUNT                                | 得到的Redis命令的总数                      |
| COMMAND GETKEYS                              | 给予充分的Redis命令提取键                  |
| COMMAND INFO command-name [command-name ...] | 获取具体的Redis命令的详细信息数组          |
| CONFIG GET parameter                         | 获取配置参数的值                           |
| CONFIG REWRITE                               | 重写的存储器配置的配置文件                 |
| CONFIG SET parameter value                   | 配置参数设置为给定值                       |
| CONFIG RESETSTAT                             | 复位信息返回的统计                         |
| DBSIZE                                       | 返回所选数据库中的键的数目                 |
| DEBUG OBJECT key                             | 获取有关的一个关键的调试信息               |
| DEBUG SEGFAULT                               | 使服务器崩溃                               |
| FLUSHALL                                     | 从所有数据库中删除所有项                   |
| FLUSHDB                                      | 从当前数据库中删除所有项                   |
| INFO [section]                               | 获取有关服务器的信息和统计数据             |
| LASTSAVE                                     | 获得最后成功的UNIX时间时间戳保存到磁盘     |
| MONITOR                                      | 监听由实时服务器接收到的所有请求           |
| ROLE                                         | 返回在复制的情况下实例的角色               |
| SAVE                                         | 同步保存数据集到磁盘（快照）               |
| SHUTDOWN [NOSAVE] [SAVE]                     | 同步的数据集保存到磁盘，然后关闭服务器     |
| SLAVEOF host port                            | 使服务器为另一个实例的从站或者促进其作为主 |
| SLOWLOG subcommand [argument]                | 管理Redis的慢查询日志                      |
| SYNC                                         | 命令用于复制                               |
| TIME                                         | 返回当前服务器时间                         |


## 持久化 ##

两种持久化策略

* RDB：相当于照快照，默认开启
	- 优点
		+ 速度快，占用空间小
		+ 适用于灾难备份
	- 缺点
		+ 符合要求就会照快照，占用系统资源（突然的），小内存机器不适合使用
			* 服务器正常关闭时
				- redis-cli shutdown
			* key满足条件时
				- save 900 1 每900秒，有一个key发生变化
				- save 300 10 每5分钟，至少有10个key发生变化
				- save 60 10000 每60秒，至少有10000个key发生变化
* AOF：使用日志功能保存数据，默认关闭
	- 机制：只保存导致key发生变化的语句
		+ everysec 每秒同步，默认机制（安全性低，节省资源）
		+ always 每修改同步（比较安全，浪费资源）
		+ no 完全交给操作系统，操作系统不繁忙时同步（不安全）
	- 优点
		+ 持续性占用少量资源
	- 缺点
		+ 日志文件会很大，不适用于灾难恢复

```
appendonly yes

# appendfsync always
appendfsync everysec
# appendfsync no

```

## 备份和还原

### 备份 ###

Redis SAVE命令用来创建备份当前Redis数据库。

```shell
127.0.0.1:6379> SAVE

OK
```

这个命令将创建dump.rdb文件在Redis目录。

要创建Redis备份备用命令BGSAVE也可以的。这个命令将开始备份过程，并在后台运行。

```shell
127.0.0.1:6379> BGSAVE

Background saving started
```


### 还原 ###

要恢复Redis数据只是移动Redis备份文件(dump.rdb)到Redis目录，然后启动服务器。为了让Redis读取到Redis目录，使用CONFIG命令如下所示：

```shell
redis 127.0.0.1:6379> config get dir
1) "dir"
2) "/var/lib/redis"
```

在上述的输出命令/var/lib/redis是目录，在安装redis服务器。

## 安全 ##

Redis数据库可以设置安全，所以做出相关的任何客户端都需要在执行命令之前进行身份验证。为了确保Redis需要设置在配置文件中的密码验证一致。

```shell
127.0.0.1:6379> CONFIG get requirepass
1) "requirepass"
2) ""
127.0.0.1:6379> CONFIG set requirepass "yiibai"
OK
127.0.0.1:6379> CONFIG get requirepass
1) "requirepass"
2) "yiibai"
```

在配置文件中修改：

```
requirepass password
```

**认证**

```shell
127.0.0.1:6379> AUTH "yiibai"
OK
127.0.0.1:6379> SET mykey "Test value"
OK
127.0.0.1:6379> GET mykey
"Test value"
```

```shell
redis-cli -h 127.0.0.1 -p 6379 -a password
```

## 性能 ##

Redis的基准是实用程序运行n个命令检查Redis 的性能。

```shell
redis-benchmark -n 100000

PING_INLINE: 141043.72 requests per second
PING_BULK: 142857.14 requests per second
SET: 141442.72 requests per second
GET: 145348.83 requests per second
INCR: 137362.64 requests per second
LPUSH: 145348.83 requests per second
LPOP: 146198.83 requests per second
SADD: 146198.83 requests per second
SPOP: 149253.73 requests per second
LPUSH (needed to benchmark LRANGE): 148588.42 requests per second
LRANGE_100 (first 100 elements): 58411.21 requests per second
LRANGE_300 (first 300 elements): 21195.42 requests per second
LRANGE_500 (first 450 elements): 14539.11 requests per second
LRANGE_600 (first 600 elements): 10504.20 requests per second
MSET (10 keys): 93283.58 requests per second
```

Redis的基准有许多可供选择

| 选项  | 描述                                  | 默认值    |
| :---  | :---                                  | :---      |
| -h    | 指定服务器的主机名                    | 127.0.0.1 |
| -p    | 指定服务器端口                        | 6379      |
| -s    | 指定服务器套接字                      |           |
| -c    | 指定并行连接数                        | 50        |
| -n    | 指定请求总数                          | 10000     |
| -d    | 指定以字节为单位设置/获取值的数据大小 | 2         |
| -k    | 1=保持活动0=重新连接                  | 1         |
| -r    | 使用随机键对SET/GET/INCR，随机SADD值  |           |
| -p    | 管道<numreq>请求                      | 1         |
| -h    | 指定服务器的主机名                    |           |
| -q    | Redis强制安静操作。只显示查询/秒值    |           |
| --csv | 输出为CSV格式                         |           |
| -l    | 产生循环，永远运行测试                |           |
| -t    | 只有运行的逗号分隔的测试列表。        |           |
| -I    | 空闲模式。刚刚开N个空闲连接和等待。   |           |

```shell
redis-benchmark -h 127.0.0.1 -p 6379 -t set,lpush -n 100000 -q

SET: 146198.83 requests per second
LPUSH: 145560.41 requests per second
```

### 客户端设置 ###


Redis接受上配置监听TCP端口和Unix套接字客户端的连接，如果启用。当一个新的客户端连接被接受，如有以下操作进行：

客户端套接字置于非阻塞状态，因为Redis的使用复用和非阻塞I/O操作。

TCP_NODELAY选项设定是为了以确保我们没有连接延迟。

创建一个可读的文件时，这样Redis能够尽快收集客户端的查询作为新的数据可供读取的Socket中。

**客户端的最大数量**

```shell
config get maxclients

1) "maxclients"
2) "10000"
```

默认情况下，此属性设置为10000(这取决于操作系统的文件描述符限制最大数量)，但你可以改变这个属性。.

```shell
redis-server --maxclients 100000
```

| 命令           | 描述                                                                  |
| :---           | :---                                                                  |
| CLIENT LIST    | 返回客户端的列表连接到Redis服务器                                     |
| CLIENT SETNAME | 指定名称的当前连接                                                    |
| CLIENT GETNAME | 返回由CLIENT SETNAME设置当前连接的名称。                              |
| CLIENT PAUSE   | 这是一个连接控制命令可以暂停所有Redis客户指定的时间量(以毫秒为单位)。 |
| CLIENT KILL    | 该命令关闭特定的客户端连接。                                          |

## 管道 ##

**管道传输的含义**

管道的基本含义是，客户端可以发送多个请求给服务器，而无需等待答复所有，并最后读取在单个步骤中的答应。

要检查redis的管道，只要开始Redis的实例，然后在终端键入以下命令。

```shell
$(echo -en "PING\r\n SET tutorial redis\r\nGET tutorial\r\nINCR visitor\r\nINCR visitor\r\nINCR visitor\r\n"; sleep 10) | nc localhost 6379

+PONG
+OK
redis
:1
:2
:3
```

在上述例子中，我们必须使用PING命令检查Redis的连接，之后，我们已经设定Redis字符串的值命名为tutorial，之后取到key值和增量参访问数的三倍。在结果中，我们可以检查所有的命令都一次提交给Redis，Redis在单一步骤中给定所有命令的输出。

**管道的好处**

这种技术的好处是显着提高协议的性能。获得通过管道范围从5个之中的一个因素的连接提高，localhost至少达到过百倍的网络连接速度。

## 分区 ##

分区是一种将数据分成多个Redis的情况下，让每一个实例将只包含关键字的子集的过程。

**分区的好处**

* 它允许更大的数据库，使用的多台计算机的内存的总和。如果不分区，一台计算机有限的内存可以支持有限的数量。
* 它允许以大规模的计算能力，以多个内核和多个计算机，以及网络带宽向多台计算机和网络适配器在一起使用。

**分区的缺点**

* 通常不支持涉及多个按键的操作。例如，不能两个集合之间执行交叉点，如果它们被存储在被映射到不同的Redis实例中的键。
* 涉及多个键的Redis事务不能被使用。
* 分区粒度是键，所以它不可能将分片数据集用一个硕大的键在一个非常大的有序集合。
* 当分区时，数据处理比较复杂，比如要处理多个RDB/AOF文件，使数据备份，需要从多个实例和主机聚集持久性文件。
* 添加和删除的能力可能很复杂。比如Redis集群支持有加，并在运行时删除节点不支持此功能的能力，但其他系统，如客户端的分区和代理的数据大多是透明平衡。有一个叫Presharding技术有助于解决这方面的问题。

### 分区的类型 ###
redis提供两种类型的分区。假设我们有四个的Redis实例R0，R1，R2，R3和代表用户喜欢的用户很多键： user:1, user:2, ... 等等

#### 范围分区 ####
范围分区被映射对象转化为具体的Redis实例的范围内实现。假定在本例中用户ID0〜ID10000将进入实例R0，而用户形成ID10001至20000号将进入实例R1等等。

#### 散列分区 ####
在这种类型的分区，一个散列函数(例如，模数函数)被用于转换键成数字，然后数据被存储在不同地方 - 它们是不同redis的实例。


*以上资源来源于Redis快速入门*
http://www.yiibai.com/redis/redis_quick_guide.html

---

## 使用场景

* 关系型数据库的缓存存在
* 做任务队列
* 大量数据集合运算
* 大量数据排序

## 启动和连接

```shell
# 后端启动需要配置daemonize yes
redis-server ./redis.confg
service redis-server start
# --raw命令获取中文不会返回unicode编码
redis-cli -h 127.0.0.1 -p 6379 --raw
# 正常停止redis
redis-cli -h 127.0.0.1 -p 6379 shutdown
```

## Redis存储key设计

> [表名]:[主键名]:[主键值]:[列名]


```shell
set b2c_user:id:1:name zhangsan
keys b2c_user:id:1*
get b2c_user:id:1:name
```

## 绑定多个IP

```shell
# 2.8 以后可以绑定到多个特定的地址上
bind 127.0.0.1 192.168.3.3
```


*以上资源来源于传智播客Redis视频教程*
